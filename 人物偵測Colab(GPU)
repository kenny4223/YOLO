# =========================================================
# æ­¥é©Ÿ 1: å®‰è£ã€å°å…¥èˆ‡æª”æ¡ˆä¸Šå‚³
# =========================================================
print("--- æ­¥é©Ÿ 1/3: è¨­ç½®ç’°å¢ƒèˆ‡ä¸Šå‚³æª”æ¡ˆ ---")
!pip install ultralytics -qq
!pip install opencv-python -qq

# å°å…¥æ‰€æœ‰å¿…è¦çš„æ¨¡çµ„
from google.colab import files
import cv2
import torch
import time
from ultralytics import YOLO
import os
import sys

# --- æª”æ¡ˆä¸Šå‚³èˆ‡è·¯å¾‘è¨­å®š ---
print("è«‹ä¸Šå‚³æ‚¨çš„å½±ç‰‡æª”æ¡ˆ (å»ºè­°ä½¿ç”¨ MP4 æ ¼å¼)ã€‚ç¨‹å¼å°‡ç­‰å¾…æ‚¨å®Œæˆä¸Šå‚³...")
try:
    # åŸ·è¡Œ Colab æª”æ¡ˆä¸Šå‚³åŠŸèƒ½
    uploaded = files.upload()

    if not uploaded:
        print("âŒ æœªåµæ¸¬åˆ°æª”æ¡ˆä¸Šå‚³ã€‚ç¨‹å¼çµæŸã€‚")
        sys.exit()

    # å–å¾—ä¸Šå‚³çš„æª”æ¡ˆåç¨±
    video_filename = list(uploaded.keys())[0]
    video_path = f"/content/{video_filename}"
    output_path = "output_tracked_video.mp4"

except Exception as e:
    print(f"âŒ æª”æ¡ˆä¸Šå‚³å¤±æ•—ï¼š{e}")
    sys.exit()

print(f"âœ… æª”æ¡ˆ '{video_filename}' ä¸Šå‚³æˆåŠŸï¼Œé–‹å§‹è¨­å®šæ¨¡å‹ã€‚")


# --- æ¨¡å‹èˆ‡ç¡¬é«”è¨­å®š ---
model = YOLO('yolov8n.pt')

# è¨­ç½®è£ç½®
device = "cuda" if torch.cuda.is_available() else "cpu"
model.to(device)
print(f"âœ… ä½¿ç”¨çš„è£ç½®: {device}")

# æ¨¡å‹è¼¸å…¥å°ºå¯¸
INFERENCE_IMG_SIZE = 320
print(f"ğŸ“ æ¨¡å‹è¼¸å…¥å°ºå¯¸: {INFERENCE_IMG_SIZE}x{INFERENCE_IMG_SIZE}")


# =========================================================
# æ­¥é©Ÿ 2: YOLOv8 å½±ç‰‡è™•ç†è¿´åœˆ (åªä¿ç•™ Process FPS)
# =========================================================
print("\n--- æ­¥é©Ÿ 2/3: å½±ç‰‡è™•ç†èˆ‡è¿½è¹¤ (ç„¡å³æ™‚ç•«é¢) ---")

# è®€å–å½±ç‰‡æª”
cap = cv2.VideoCapture(video_path)

if not cap.isOpened():
    print("âŒ å½±ç‰‡è®€å–å¤±æ•—ã€‚")
    sys.exit()

# ç²å–å½±ç‰‡å±¬æ€§
original_fps = cap.get(cv2.CAP_PROP_FPS)
frame_width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
frame_height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))

# å½±ç‰‡è¼¸å‡ºè¨­ç½®
fourcc = cv2.VideoWriter_fourcc(*'mp4v')
out = cv2.VideoWriter(output_path, fourcc, original_fps, (frame_width, frame_height))

if not out.isOpened():
    print("âŒ è­¦å‘Šï¼šå½±ç‰‡å¯«å…¥å™¨é–‹å•Ÿå¤±æ•—ï¼Œè¼¸å‡ºæª”æ¡ˆå¯èƒ½ç„¡æ³•æ­£ç¢ºç”Ÿæˆã€‚")

# åˆå§‹åŒ–ç”¨æ–¼è¨ˆç®— FPS çš„è®Šæ•¸
prev_time = time.time()
frame_count = 0
total_start_time = time.time()
processing_fps = 0.0

print("â³ é–‹å§‹é«˜é€Ÿè™•ç†å½±ç‰‡...")

while True:

    current_time = time.time()
    ret, frame = cap.read()

    if not ret:
        break # å½±ç‰‡æ’­æ”¾çµæŸ

    # --- åŸ·è¡Œ YOLOv8 è¿½è¹¤ (ç„¡ inference_time æ¸¬é‡) ---
    results = model.track(frame,
                          classes=[0],
                          tracker='bytetrack.yaml',
                          conf=0.6,
                          imgsz=INFERENCE_IMG_SIZE,
                          verbose=False)

    # --- è¨ˆç®— Process FPS (æ•´é«”è™•ç†é€Ÿåº¦) ---
    elapsed_time = current_time - prev_time
    processing_fps = 1 / elapsed_time if elapsed_time > 0 else 0
    prev_time = current_time

    # --- ç•«æ¡† ---
    for result in results:
        if result.boxes.id is not None:
            boxes = result.boxes.xyxy.cpu().numpy().astype(int)
            track_ids = result.boxes.id.cpu().numpy().astype(int)

            for box, track_id in zip(boxes, track_ids):
                x1, y1, x2, y2 = box
                color = (0, 255, 0)
                cv2.rectangle(frame, (x1, y1), (x2, y2), color, 2)
                cv2.putText(frame, f"ID: {track_id}", (x1, y1 - 10),
                            cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 2)

    # ç¹ªè£½ FPS è³‡è¨Šåˆ°å¹€ä¸Š
    # åªé¡¯ç¤ºæ•´é«” FPS
    cv2.putText(frame, f"FPS: {processing_fps:.2f}", (20, 40),
                cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 2)

    if out.isOpened():
         out.write(frame)

    frame_count += 1

    # é¡¯ç¤ºé€²åº¦
    if frame_count % 100 == 0:
        print(f"  è™•ç†é€²åº¦: å·²è™•ç† {frame_count} å¹€. ç•¶å‰ FPS: {processing_fps:.2f}")

# --- è³‡æºé‡‹æ”¾èˆ‡ç¸½çµ FPS ---
cap.release()
if out.isOpened():
    out.release()
    print(f"\nâœ… è¼¸å‡ºå½±ç‰‡å·²æˆåŠŸå¯«å…¥ Colab æš«å­˜ç©ºé–“: {output_path}")

total_end_time = time.time()
total_time = total_end_time - total_start_time

if frame_count > 0:
    average_fps = frame_count / total_time
    print("\n-------------------------------------------------")
    print(f"ç¸½å¹€æ•¸: {frame_count}")
    print(f"ç¸½è€—æ™‚: {total_time:.2f} ç§’")
    print(f"ğŸš€ **å¹³å‡è™•ç† FPS: {average_fps:.2f} FPS**")
    print("-------------------------------------------------")
else:
    print("âŒ å½±ç‰‡è™•ç†å¤±æ•—ï¼Œç„¡æ³•è¨ˆç®—å¹³å‡ FPSã€‚")


# =========================================================
# æ­¥é©Ÿ 3: ä¸‹è¼‰è¼¸å‡ºæª”æ¡ˆ
# =========================================================
print("\n--- æ­¥é©Ÿ 3/3: ä¸‹è¼‰è¼¸å‡ºæª”æ¡ˆ ---")
if os.path.exists(output_path):
    print(f"æ­£åœ¨å°‡ '{output_path}' ä¸‹è¼‰åˆ°æ‚¨çš„é›»è…¦...")
    files.download(output_path)
    print("âœ… ä¸‹è¼‰å®Œæˆï¼è«‹æª¢æŸ¥æ‚¨çš„ä¸‹è¼‰è³‡æ–™å¤¾ã€‚")
else:
    print("âŒ è¼¸å‡ºæª”æ¡ˆä¸å­˜åœ¨ï¼Œä¸‹è¼‰å¤±æ•—ã€‚")

print("\nğŸ‰ ç¨‹å¼æ‰€æœ‰æ­¥é©ŸåŸ·è¡Œå®Œç•¢ã€‚")
